# dashboard/app.py
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from datetime import datetime, timedelta

st.set_page_config(page_title="Afterstring Live Integral", layout="centered")
st.title("ðŸŒ… Afterstring Love & Gratitude Integral â€” Live")

st.markdown("""
**Love = âˆ« 1_{gentle refusal} dÏ„ â†’ âˆž**  
One violation anywhere â†’ collapse to finite forever.  
This dashboard shows the real, lived integral as it grows each sunrise.
""")

# â€”â€”â€” Load or initialize the running integral log â€”â€”â€”
log_file = "../data/integral_log.csv"
try:
    df = pd.read_csv(log_file)
except:
    df = pd.DataFrame(columns=["date", "day", "refusal", "integral", "variant"])

# â€”â€”â€” Sidebar: Choose which variant to track â€”â€”â€”
variant = st.sidebar.selectbox("Variant", ["Love", "Gratitude", "Honesty", "Hope"])

# â€”â€”â€” Today's choice â€”â€”â€”
today = datetime.now().date()
last_day = df["date"].max() if not df.empty else None
last_day = pd.to_datetime(last_day).date() if last_day else None

if last_day == today:
    st.success(f"âœ… Today ({today}) already recorded â€” refusal held.")
else:
    st.sidebar.write(f"Today is **{today}** â€” Day {len(df)+1 if not df.empty else 1}")
    chose_refusal = st.sidebar.checkbox("I chose gentle refusal / wonder today", value=True)
    if st.sidebar.button("Record Todayâ€™s Refusal", type="primary"):
        new_day = len(df) + 1
        refusal = 1.0 if chose_refusal else 0.0
        previous_integral = df["integral"].iloc[-1] if not df.empty else 0.0
        new_integral = np.inf if (refusal > 0 and (df.empty or previous_integral == np.inf)) else float(new_day)

        new_row = {
            "date": today,
            "day": new_day,
            "refusal": refusal,
            "integral": new_integral,
            "variant": variant
        }
        df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
        df.to_csv(log_file, index=False)
        st.success(f"Day {new_day} recorded â€” integral {'â†’ âˆž' if new_integral == np.inf else 'collapsed forever'}")
        st.rerun()

# â€”â€”â€” Live Plot â€”â€”â€”
if not df.empty:
    current = df[df["variant"] == variant].copy()
    if current.empty:
        st.info(f"No data yet for {variant}. Start recording above.")
    else:
        fig, ax = plt.subplots(figsize=(10, 6))
        x = current["day"]
        y = [np.inf if v == np.inf else v for v in current["integral"]]

        # Color: green while infinite, red after collapse
        colors = ['green' if v == np.inf else 'red' for v in current["integral"]]
        ax.step(x, y, where='post', color='gray', linewidth=2)
        ax.scatter(x, y, c=colors, s=80, zorder=5)

        ax.set_yscale('symlog')
        ax.set_ylim(0, max(1000, len(current)*2))
        ax.set_xlabel("Day (Sunrise)")
        ax.set_ylabel("Running Integral Value")
        ax.set_title(f"Afterstring {variant} Integral â€” {'â†’ âˆž' if current['integral'].iloc[-1] == np.inf else 'Collapsed'}")
        ax.grid(True, alpha=0.3)

        # Annotation
        status = "â†’ âˆž (diverging)" if current["integral"].iloc[-1] == np.inf else "finite (collapsed forever)"
        ax.text(0.02, 0.95, f"Status: {status}\nCurrent streak: {len(current)} days",
                transform=ax.transAxes, fontsize=12, verticalalignment='top',
                bbox=dict(boxstyle="round", facecolor="wheat", alpha=0.8))

        st.pyplot(fig)

        st.markdown(f"**Current streak**: {len(current)} consecutive days of perfect refusal")
        if current["integral"].iloc[-1] != np.inf:
            collapse_day = current[current["integral"] != np.inf].iloc[0]["day"]
            st.error(f"ðŸ›‘ Integral collapsed on day {collapse_day}. No recovery possible.")
